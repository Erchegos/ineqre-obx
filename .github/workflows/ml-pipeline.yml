name: ML Daily Pipeline

on:
  schedule:
    # 01:00 UTC = 02:00 CET (winter) / 03:00 CEST (summer)
    # Well after Oslo Bors closes at 16:30 CET, weekdays only
    - cron: '0 1 * * 1-5'
  workflow_dispatch:
    inputs:
      from_step:
        description: 'Resume from step number (1-6)'
        required: false
        default: '1'
        type: choice
        options: ['1', '2', '3', '4', '5', '6']

jobs:
  ml-pipeline:
    name: Factor Calculation & Prediction Generation
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Create env file
        working-directory: apps/web
        run: echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env.local

      - name: Run ML Pipeline
        working-directory: apps/web
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_TLS_REJECT_UNAUTHORIZED: '0'
        run: |
          FROM_STEP="${{ github.event.inputs.from_step || '1' }}"
          if [ "$FROM_STEP" != "1" ]; then
            npx tsx scripts/ml-daily-pipeline.ts --from=$FROM_STEP
          else
            npx tsx scripts/ml-daily-pipeline.ts
          fi

      - name: Pipeline Summary
        if: always()
        run: |
          echo "## ML Pipeline Run" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.from_step }}" != "" ] && [ "${{ github.event.inputs.from_step }}" != "1" ]; then
            echo "- **Resumed from step**: ${{ github.event.inputs.from_step }}" >> $GITHUB_STEP_SUMMARY
          fi
