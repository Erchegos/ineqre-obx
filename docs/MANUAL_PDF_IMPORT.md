# Manual PDF Import Guide

This guide explains how to manually add research PDFs to the research portal.

## Overview

The manual PDF import system allows you to add research documents that weren't received via email. The system will:

- Extract text from PDFs
- Generate AI summaries using Claude API
- Store PDFs in Supabase for download
- Make documents searchable on the website
- Display them alongside auto-imported email research

## Folder Structure

Place PDFs in the following folders based on their type:

```
Manual_PDF_Analysis/
├── DNB_Carnegie_05.01.2026.pdf          # Weekly market commentaries (root level)
├── DNB_Carnegie_12.01.2026.pdf
├── DNB_Carnegie_19.01.2026.pdf
├── Individual_Stocks_Pareto/            # Pareto individual stock reports
│   ├── Kongsberg_Gruppen_update_23.01.2026.pdf
│   ├── Storebrand_update_23.01.2026.pdf
│   └── Mips_update_23.01.2026.pdf
└── Individual_Stocks_DNB_Carnegie/      # DNB Carnegie individual stock reports
    ├── Aker_update_15.01.2026.pdf
    ├── Entra_update_14.01.2026.pdf
    └── Frontline_update_16.01.2026.pdf
```

## File Naming Convention

Use the following format for PDF filenames:

```
CompanyName_type_DD.MM.YYYY.pdf
```

**Examples:**
- `Kongsberg_Gruppen_update_23.01.2026.pdf`
- `Storebrand_quarterly_preview_15.01.2026.pdf`
- `DNB_Carnegie_19.01.2026.pdf`

**Important:**
- Include the date in `DD.MM.YYYY` format
- Use underscores (`_`) to separate parts
- Be consistent with company names

## Supported Company Tickers

The system automatically maps company names to tickers for OBX stocks:

| Company Name | Ticker | Example Filename |
|--------------|--------|------------------|
| Entra | ENTRA | `Entra_update_14.01.2026.pdf` |
| Frontline | FRO | `Frontline_update_16.01.2026.pdf` |
| Kongsberg | KOG | `Kongsberg_Gruppen_update_20.01.2026.pdf` |
| Norwegian | NAS | `Norwegian_Air_Shuttle_update_16.01.2026.pdf` |
| Storebrand | STB | `Storebrand_update_23.01.2026.pdf` |

**Note:** For stocks not in the OBX index (like MIPS, Aker, Stolt-Nielsen), the ticker will be set to NULL but the document will still be processed.

## Running the Import

1. **Place PDFs in appropriate folders** (see folder structure above)

2. **Run the import script:**
   ```bash
   NODE_TLS_REJECT_UNAUTHORIZED=0 node scripts/process-manual-pdfs.js
   ```

3. **Monitor the output:**
   ```
   Processing: Kongsberg_Gruppen_update_23.01.2026.pdf
     Extracting text...
     ✓ Extracted 47454 characters
     Ticker: KOG
     Date: 2026-01-20
     Type: Update
     Generating AI summary...
     ✓ Generated summary (1516 chars)
     ✓ Created document a6983847-fef1-4717-9ace-1f7d4c0add14
     Uploading to Supabase...
     ✓ Uploaded to Supabase
     ✓ Complete!
   ```

## What Gets Imported

For each PDF, the system extracts and stores:

### Document Metadata
- **Subject:** Extracted from filename (e.g., "Kongsberg Gruppen update 23.01.2026")
- **Ticker:** Mapped from company name if available
- **Date:** Extracted from filename
- **Document Type:** Determined from filename (Update, Quarterly Preview, etc.)
- **Source:** Set to "Manual Upload"

### Document Content
- **Body Text:** First 3000 characters of extracted PDF text
- **AI Summary:** 2-3 paragraph summary generated by Claude Haiku, including:
  - Main thesis or recommendation
  - Key financial metrics or estimates
  - Important events, catalysts, or changes
  - Target price or valuation if mentioned

### PDF Attachment
- Uploaded to Supabase Storage
- Organized by year/month/document_id
- Downloadable from research portal

## Viewing on Website

After import, documents appear on the research portal at `/research` with:

- ✅ AI-generated summaries visible in preview
- ✅ Full PDF downloadable
- ✅ Searchable by ticker, subject, or content
- ✅ Filterable by date, source, and ticker
- ✅ Same display format as auto-imported emails

## Updating Existing Documents

If you need to regenerate AI summaries for existing manual uploads:

```bash
NODE_TLS_REJECT_UNAUTHORIZED=0 node scripts/update-manual-summaries.js
```

This will find all manual upload documents without AI summaries and generate them.

## Troubleshooting

### "Document already exists"
The system checks for duplicate documents by matching subject and date. If you see this message, the PDF has already been imported.

### "Ticker not in database"
The company isn't in the OBX index or the ticker mapping is missing. The document will still be imported with `ticker = NULL`.

### "Claude API error"
Check that `ANTHROPIC_API_KEY` is set in your `.env` file and has sufficient credits.

### "PDF appears empty"
The PDF text extraction failed. This can happen with:
- Scanned PDFs (images only, no text layer)
- Protected/encrypted PDFs
- Corrupted PDF files

Try opening the PDF manually to verify it contains selectable text.

## Technical Details

### Scripts

- **`scripts/process-manual-pdfs.js`** - Main import script
  - Scans Manual_PDF_Analysis folder structure
  - Extracts text using pdf-parse library
  - Generates summaries via Claude Haiku API
  - Validates tickers against database
  - Uploads to Supabase Storage
  - Creates database records

- **`scripts/update-manual-summaries.js`** - Backfill utility
  - Updates existing documents without summaries
  - Useful after API failures or script improvements

### Database Schema

Documents are stored in `research_documents` table:
```sql
{
  id: uuid (auto-generated)
  ticker: varchar (nullable)
  source: varchar = 'Manual Upload'
  sender_email: varchar = 'manual@upload.local'
  subject: text
  body_text: text (first 3000 chars)
  ai_summary: text (Claude-generated)
  received_date: timestamp
  document_type: varchar
  has_attachments: boolean = true
  attachment_count: integer = 1
}
```

Attachments stored in `research_attachments` table:
```sql
{
  id: uuid
  document_id: uuid (foreign key)
  filename: varchar
  content_type: varchar = 'application/pdf'
  file_size: integer
  file_path: varchar (Supabase Storage path)
}
```

### Storage

PDFs are stored in Supabase Storage bucket `research-pdfs`:
```
research-pdfs/
  2026/
    01/
      [document-id]/
        Kongsberg_Gruppen_update_23.01.2026.pdf
```

## Adding New Tickers

To add support for new company tickers, edit `scripts/process-manual-pdfs.js`:

```javascript
// Map common company names to tickers (only OBX tickers)
const tickerMap = {
  'entra': 'ENTRA',
  'frontline': 'FRO',
  'kongsberg': 'KOG',
  'norwegian': 'NAS',
  'storebrand': 'STB',
  'yournewcompany': 'TICKER',  // Add here
};
```

Make sure the ticker exists in the `stocks` table first.
